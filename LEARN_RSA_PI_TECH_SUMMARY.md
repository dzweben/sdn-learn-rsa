# LEARN RSA — PI‑Facing Technical Summary

## Scope
This document is a concise, technical explanation of **how** the RSA run‑wise GLM is constructed (timing, model, GLTs) and how missing confounds were identified and fixed. It is meant to be readable while retaining key implementation details.

## Timing Files (Run‑Wise)
- Timing files are generated **per subject** from BIDS events to:
  - `RSA-learn/TimingFiles/Full/sub-<ID>/NonPM_*_runX.1D`
- Each timing file has **4 rows** (one per run). Runs with no events are marked with `*`.
- AFNI is forced to interpret these as **local (per‑run) timings** using:
  - `-local_times`

## GLM Model Specification (AFNI)
- Generated by `afni_proc.py` via `LEARN_ap_Full_RSA_runwise.sh`.
- Uses **AM1 timing** with **`dmBLOCK(0)`** basis:
  - `-regress_stim_times_AM1` + `-regress_basis_multi 'dmBLOCK(0)'`
- **Run‑wise regressors:**
  - 8 peer×feedback regressors per run (FBM/FBN × Mean60/Mean80/Nice60/Nice80)
- **Additional regressors:**
  - 8 prediction/response regressors (`Pred.*`, `Resp.*`)
- **Total** for 4‑run subjects: **40 stimulus regressors**
- Serial autocorrelation modeled with **3dREMLfit**.

## Outputs (Run‑Wise + Across‑Run Averages)
- **Per‑run betas:** 14 per run (4 peer + 2 feedback + 8 peer×feedback)
- **Across‑run averages:** computed using **GLTs** as weighted sums of run‑wise betas.
  - 4‑run subjects use weights of 1/4.
  - 2–3 run subjects use weights of 1/N (dynamic GLTs).
- This produces the **same 14 contrasts** averaged across available runs.

## Confounds (Nuisance Regressors)
- The GLM includes three confound files per subject:
  - `aCompCor6.1D` = a_comp_cor_00–05 (WM/CSF noise components)
  - `cosine.1D` = cosine* high‑pass drift regressors
  - `fd.1D` = framewise displacement (NaN→0)
- These live at:
  - `/derivatives/afni/confounds/sub-<ID>/sub-<ID>_task-learn_allruns_{aCompCor6,cosine,fd}.1D`

## Missing Confounds — Identification & Fix
**Problem:** Some subjects failed with errors like:
- `cp: cannot stat ... aCompCor6/cosine/fd`

**Cause:** The AFNI confounds `.1D` files were missing (not a task/behavior issue).

**Fix (not guesswork):** Rebuilt missing `.1D` files **directly from fMRIPrep TSVs**:
- Source:
  - `/derivatives/fmriprep/sub-<ID>/func/sub-<ID>_task-learn_run-*_desc-confounds_timeseries.tsv`
- Mapping:
  - `a_comp_cor_00..05 → aCompCor6.1D`
  - `cosine* → cosine.1D`
  - `framewise_displacement (NaN→0) → fd.1D`
- Concatenate run‑wise rows into all‑runs `.1D` files per subject.

## Key AFNI Options That Matter
- `-local_times`: interprets each timing row as a run (prevents global timing errors)
- `-allzero_OK`: allows regressors with no events in a given run
- GLTs encode across‑run averages **without collapsing** the run‑wise design

