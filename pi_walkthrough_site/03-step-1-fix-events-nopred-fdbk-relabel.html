<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Step 1 – Fix events (nopred_fdbk relabel) – LEARN RSA PI Walkthrough</title>
  <link rel="stylesheet" href="assets/style.css">
</head>
<body>
  <div class="layout">
    <nav class="sidebar">
      <div class="site-title">LEARN RSA PI Walkthrough</div>
      <ul class="nav">
  <li class=""><a href="index.html">Overview</a></li>
  <li class=""><a href="02-step-0-map-of-paths-and-environment.html">Step 0 – Map of Paths and Environment</a></li>
  <li class="active"><a href="03-step-1-fix-events-nopred-fdbk-relabel.html">Step 1 – Fix events (nopred_fdbk relabel)</a></li>
  <li class=""><a href="04-step-2-generate-run-wise-timing-files-nonpm.html">Step 2 – Generate run-wise timing files (NonPM)</a></li>
  <li class=""><a href="05-step-3-generate-afni-proc-scripts-no-blur-from-raw-bids.html">Step 3 – Generate AFNI proc scripts (no blur) from raw BIDS</a></li>
  <li class=""><a href="06-step-4-run-availability-audit-raw-bids.html">Step 4 – Run availability audit (raw BIDS)</a></li>
  <li class=""><a href="07-step-5-run-the-full-afni-pipeline-proc-glm-in-tmux.html">Step 5 – Run the full AFNI pipeline (proc + GLM) in tmux</a></li>
  <li class=""><a href="08-step-6-audit-post-run-checks.html">Step 6 – Audit (post-run checks)</a></li>
  <li class=""><a href="09-setback-b-sub-1522-glm-collinearity.html">Setback B – sub-1522 GLM collinearity</a></li>
</ul>
    </nav>
    <main class="content">
      <article>
        <h2 id="step-1-fix-events-nopred_fdbk-relabel">Step 1 – Fix events (nopred_fdbk relabel)</h2>
<p>Purpose: some feedback events were labeled <code>nopred_fdbk</code> in BIDS events when a prediction was missed. This broke run-wise timing generation because those events did not match the expected peer×feedback labels. Fix = relabel those events using a canonical run template.</p>
<p>Command used:</p>
<pre><code class="language-bash">python3 /data/projects/STUDIES/LEARN/fMRI/RSA-learn/scripts/LEARN_fix_nopred_fdbk_by_template.py \
  --bids-dir /data/projects/STUDIES/LEARN/fMRI/RSA-learn/bids_fixed \
  --out-dir  /data/projects/STUDIES/LEARN/fMRI/RSA-learn/bids_fixed2 \
  --report   /data/projects/STUDIES/LEARN/fMRI/RSA-learn/reports/nopred_fdbk_fix_template.tsv \
  --mode majority
</code></pre>
<p>Script (full): <code>rsa-learn/scripts/LEARN_fix_nopred_fdbk_by_template.py</code></p>
<pre><code class="language-python">#!/usr/bin/env python3
&quot;&quot;&quot;
Relabel `nopred_fdbk` in BIDS events.tsv using the canonical
peer×feedback order derived from normal participants.

Two modes:
  - majority: build a per-run template from the majority label at each trial
  - subject:  use a single normal subject as the template
&quot;&quot;&quot;

from __future__ import annotations

import argparse
import csv
from collections import Counter, defaultdict
from pathlib import Path

FEEDBACK = {
    &quot;Mean_60_fdkm&quot;,
    &quot;Mean_60_fdkn&quot;,
    &quot;Mean80_fdkm&quot;,
    &quot;Mean80_fdkn&quot;,
    &quot;Nice_60_fdkm&quot;,
    &quot;Nice_60_fdkn&quot;,
    &quot;Nice80_fdkm&quot;,
    &quot;Nice80_fdkn&quot;,
}


def find_events(bids_dir: Path):
    return sorted(bids_dir.glob(&quot;sub-*/func/sub-*_task-learn_run-*_events.tsv&quot;))


def sub_run_from_name(path: Path):
    name = path.name
    subj = name.split(&quot;_task-&quot;)[0].replace(&quot;sub-&quot;, &quot;&quot;)
    run = int(name.split(&quot;run-&quot;)[1].split(&quot;_events.tsv&quot;)[0])
    return subj, run


def build_template_majority(bids_dir: Path):
    counts = defaultdict(lambda: defaultdict(Counter))
    for ev in find_events(bids_dir):
        _, run = sub_run_from_name(ev)
        with ev.open() as f:
            header = f.readline().strip().split(&quot;\t&quot;)
            if &quot;event&quot; not in header:
                continue
            i_event = header.index(&quot;event&quot;)
            i_trial = header.index(&quot;trial&quot;)
            for line in f:
                if not line.strip():
                    continue
                cols = line.rstrip(&quot;\n&quot;).split(&quot;\t&quot;)
                event = cols[i_event]
                if event not in FEEDBACK:
                    continue
                trial = int(float(cols[i_trial]))
                counts[run][trial][event] += 1
    template = defaultdict(dict)
    for run, trial_map in counts.items():
        for trial, counter in trial_map.items():
            if not counter:
                continue
            most_common = counter.most_common()
            if len(most_common) &gt; 1 and most_common[0][1] == most_common[1][1]:
                continue
            template[run][trial] = most_common[0][0]
    return template


def build_template_from_subject(bids_dir: Path, subj: str):
    template = defaultdict(dict)
    for ev in find_events(bids_dir):
        s, run = sub_run_from_name(ev)
        if s != subj:
            continue
        with ev.open() as f:
            header = f.readline().strip().split(&quot;\t&quot;)
            if &quot;event&quot; not in header:
                continue
            i_event = header.index(&quot;event&quot;)
            i_trial = header.index(&quot;trial&quot;)
            for line in f:
                if not line.strip():
                    continue
                cols = line.rstrip(&quot;\n&quot;).split(&quot;\t&quot;)
                event = cols[i_event]
                if event not in FEEDBACK:
                    continue
                trial = int(float(cols[i_trial]))
                template[run][trial] = event
    return template


def main():
    ap = argparse.ArgumentParser()
    ap.add_argument(&quot;--bids-dir&quot;, required=True, type=Path)
    ap.add_argument(&quot;--out-dir&quot;, required=True, type=Path)
    ap.add_argument(&quot;--report&quot;, required=True, type=Path)
    ap.add_argument(&quot;--mode&quot;, choices=[&quot;majority&quot;, &quot;subject&quot;], default=&quot;majority&quot;)
    ap.add_argument(&quot;--template-subj&quot;, help=&quot;Required if mode=subject&quot;)
    args = ap.parse_args()

    if args.mode == &quot;subject&quot;:
        if not args.template_subj:
            raise SystemExit(&quot;Need --template-subj when mode=subject&quot;)
        template = build_template_from_subject(args.bids_dir, args.template_subj)
    else:
        template = build_template_majority(args.bids_dir)

    report_rows = []
    fixed = 0
    unresolved = 0
    total = 0

    for ev in find_events(args.bids_dir):
        rel = ev.relative_to(args.bids_dir)
        out_path = args.out_dir / rel
        out_path.parent.mkdir(parents=True, exist_ok=True)

        with ev.open() as f:
            header = f.readline().strip().split(&quot;\t&quot;)
            if &quot;event&quot; not in header:
                continue
            i_event = header.index(&quot;event&quot;)
            i_trial = header.index(&quot;trial&quot;)
            rows = [r.rstrip(&quot;\n&quot;).split(&quot;\t&quot;) for r in f if r.strip()]

        for row in rows:
            if row[i_event] != &quot;nopred_fdbk&quot;:
                continue
            total += 1
            trial = int(float(row[i_trial]))
            _, run = sub_run_from_name(ev)
            new_event = template.get(run, {}).get(trial)
            if new_event:
                row[i_event] = new_event
                fixed += 1
                report_rows.append([*sub_run_from_name(ev), row[i_trial], &quot;nopred_fdbk&quot;, new_event, &quot;fixed&quot;])
            else:
                unresolved += 1
                report_rows.append([*sub_run_from_name(ev), row[i_trial], &quot;nopred_fdbk&quot;, &quot;NA&quot;, &quot;unresolved&quot;])

        with out_path.open(&quot;w&quot;, newline=&quot;&quot;) as f:
            writer = csv.writer(f, delimiter=&quot;\t&quot;)
            writer.writerow(header)
            writer.writerows(rows)

    args.report.parent.mkdir(parents=True, exist_ok=True)
    with args.report.open(&quot;w&quot;, newline=&quot;&quot;) as f:
        writer = csv.writer(f, delimiter=&quot;\t&quot;)
        writer.writerow([&quot;subj&quot;, &quot;run&quot;, &quot;trial&quot;, &quot;old_event&quot;, &quot;new_event&quot;, &quot;status&quot;])
        writer.writerows(report_rows)

    print(f&quot;[template_fix] total={total} fixed={fixed} unresolved={unresolved}&quot;)


if __name__ == &quot;__main__&quot;:
    main()

</code></pre>
<p>Outputs:
- <code>/data/projects/STUDIES/LEARN/fMRI/RSA-learn/bids_fixed2</code> (corrected events)
- <code>/data/projects/STUDIES/LEARN/fMRI/RSA-learn/reports/nopred_fdbk_fix_template.tsv</code> (audit report)</p>
      </article>
      <div class="footer">Generated 2026-02-19 11:13
      </div>
    </main>
  </div>
</body>
</html>
